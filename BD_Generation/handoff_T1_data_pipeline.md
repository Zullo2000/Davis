# Handoff: Phase 1 Data Pipeline

> **Created:** 2026-02-13
> **Session purpose:** Implement Phase 1 (Data Pipeline) of the BD Generation project — graph2plan_loader, tokenizer, dataset, scripts, tests, docs.

---

## What was accomplished

### Step 0: Vocab Verification (COMPLETE)
- Downloaded Graph2Plan Data.zip (234 MB), extracted `data.mat` (25.3 MB) to `BD_Generation/data/data.mat`
- Verified all unique `rType` (0-12, 0-based) and `rEdge` (0-9, 0-based) values against Graph2Plan source code (`Network/model/utils.py` → `get_vocab()`)
- **Major finding: NODE_TYPES and EDGE_TYPES name-to-index mappings were completely wrong.** Updated `vocab.py` with correct mappings:
  - NODE: LivingRoom(0), MasterRoom(1), Kitchen(2), Bathroom(3), DiningRoom(4), ChildRoom(5), StudyRoom(6), SecondRoom(7), GuestRoom(8), Balcony(9), Entrance(10), Storage(11), Wall-in(12)
  - EDGE: left-above(0), left-below(1), left-of(2), above(3), inside(4), surrounding(5), below(6), right-of(7), right-above(8), right-below(9)
- All 54 existing vocab tests still pass after update
- Sizes/indices unchanged: NODE_VOCAB_SIZE=15, EDGE_VOCAB_SIZE=13

### Step 1: Workstream A + B (CODE WRITTEN, NOT YET TESTED)
- `bd_gen/data/graph2plan_loader.py` (218 lines) — .mat parser with caching, self-loop filtering, validation
- `bd_gen/data/tokenizer.py` (202 lines) — tokenize/detokenize with PAD vs no-edge invariant
- `tests/test_loader.py` (313 lines) — synthetic + real-data tests
- `tests/test_tokenizer.py` (465 lines) — roundtrip, PAD correctness, edge cases
- `scripts/prepare_data.py` (224 lines) — auto-download + parse + cache + stats

## Key decisions made

| Decision | Choice | Rationale |
|---|---|---|
| Indexing | Data is 0-based, NO subtraction needed | Verified: min(rType)=0, max(rType)=12 |
| Edge direction | Already upper-triangle (u < v) in data | Verified: 822,212 edges all u<v, plus 457 self-loops filtered |
| Relationship inversion | `9 - r` (simple formula) | Verified against the symmetric pairing in Graph2Plan's vocab |
| Graph2Plan room types 13/14 | Repurposed as MASK/PAD tokens | External(13) and ExteriorWall(14) never appear in bubble diagram data |
| n_max filtering | Not needed for RPLAN | All 80,788 graphs have 4-8 rooms (none exceed 8) |

## Current state of the codebase

**Branch:** `data/graph2plan-loader` (created from `main`)

**Working files:**
- `vocab.py` — MODIFIED (correct name mappings, VERIFIED status in docstring)
- `graph2plan_loader.py` — NEW, written by sub-agent, not yet tested
- `tokenizer.py` — NEW, written by sub-agent, not yet tested
- `test_loader.py` — NEW, written by sub-agent, not yet run
- `test_tokenizer.py` — NEW, written by sub-agent, not yet run
- `prepare_data.py` — NEW, written by sub-agent, not yet run

**Data files (gitignored):**
- `BD_Generation/data/data.mat` — 25.3 MB, 80,788 records
- `BD_Generation/data_cache/` — empty (cache will be generated by prepare_data.py)

**Known risks:** Sub-agent code has NOT been tested yet. First priority is running tests and fixing issues.

## What remains to be done

### Immediate (finish Step 1)
1. **Run tests:** `pytest BD_Generation/tests/test_vocab.py BD_Generation/tests/test_loader.py BD_Generation/tests/test_tokenizer.py -v`
2. **Fix any test failures** in loader and tokenizer
3. **Run linter:** `ruff check BD_Generation/bd_gen/ BD_Generation/tests/`
4. **Review** `prepare_data.py` and test it end-to-end

### Step 2: Sequential (dataset.py)
5. Implement `bd_gen/data/dataset.py` — BubbleDiagramDataset with splits, class weights, num_rooms_distribution
6. Implement `tests/test_dataset.py` — synthetic tests for shapes, splits, weights
7. Implement `scripts/inspect_data.py` — print dataset statistics

### Step 3: Documentation + polish
8. Create `docs/graph2plan_loader.md`, `docs/tokenizer.md`, `docs/dataset.md`
9. Update `tests/conftest.py` with new fixtures (sample_graph_dict, sample_graph_dicts)
10. Create `notebooks/01_data_exploration.ipynb`

### Step 4: Final verification
11. Full test suite pass + lint clean
12. Smoke test: DataLoader iteration works
13. Update `implementation_state_T1.md` (status: PENDING REVIEW)
14. Commit all on `data/graph2plan-loader` branch

## Files to reference in next session

**Read first (planning/state):**
1. `BD_Generation/planning_T1.md` — Phase 1 spec (lines 798-825 for tasks, 210-316 for data module specs)
2. `BD_Generation/implementation_state_T1.md` — current state tracker
3. This handoff file

**Review code (needs testing):**
4. `BD_Generation/bd_gen/data/graph2plan_loader.py` — loader implementation
5. `BD_Generation/bd_gen/data/tokenizer.py` — tokenizer implementation
6. `BD_Generation/tests/test_loader.py` — loader tests
7. `BD_Generation/tests/test_tokenizer.py` — tokenizer tests
8. `BD_Generation/scripts/prepare_data.py` — data prep script

**Foundation (already verified):**
9. `BD_Generation/bd_gen/data/vocab.py` — updated vocab (verified)
10. `BD_Generation/tests/conftest.py` — shared fixtures

## Context for the next session

### Critical data facts discovered
- **80,788 total records**, all with 4-8 rooms (no 1-3 room graphs in actual data, though code handles them)
- **Room count distribution:** 4 rooms (0.3%), 5 (7.2%), 6 (31.1%), 7 (36.2%), 8 (25.2%)
- **Edge count per graph:** 3-18, mean 10.2
- **457 self-loops** in data (filtered by loader)
- **rType=0 (LivingRoom)** appears in every single record (80,788/80,788)
- **Most common room type:** SecondRoom (index 7) with 99,987 occurrences (multiple per plan)
- **Most common edge type:** below (index 6) at 20.1%, above (index 3) at 17.6%
- **Rarest types:** Entrance (10) has only 292 records, GuestRoom (8) has 860

### Edge relationship inversion
The inverse of relationship `r` is simply `9 - r`. This works because Graph2Plan ordered the types symmetrically. The data is already in upper-triangle form so inversion is only needed as a utility.

### Plan file
The approved plan is at `C:\Users\Alessandro Zuliani\.claude\plans\sleepy-hopping-parasol.md` — contains detailed implementation specs for dataset.py (Step 2) including class weight formulas and BubbleDiagramDataset design.
